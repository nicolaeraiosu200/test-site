<!DOCTYPE html>
<html lang="ro">
<head>
    <!-- Configurare esențială pentru a asigura că site-ul este complet responsive -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magia Roz - Piața Secretă</title>

    <!-- Incarcare Tailwind CSS CDN pentru stilizare rapidă și responsivă -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import Font Awesome pentru iconițe -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Configurare Tailwind pentru a include paleta de culori tematică -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    // Paleta de culori tematică: roz, mov, turcoaz pentru un aspect "girly"
                    colors: {
                        'primary-pink': '#FF69B4',     // Hot Pink
                        'secondary-purple': '#A855F7', // Violet
                        'accent-teal': '#20C997',      // Turcoaz/Teal
                        'background-light': '#FFF0F5', // Lavender Blush (fundal ușor)
                        'card-bg': '#FFE4E1',          // Misty Rose
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        // Animații personalizate
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pop-in': 'pop-in 0.5s ease-out forwards',
                    },
                    keyframes: {
                        // Keyframes pentru animatia de plutire (float)
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        // Keyframes pentru animatia de aparitie (pop-in)
                        'pop-in': {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Blocul de Stiluri Personalizate (CSS) -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Stil pentru cardurile de postare */
        .post-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            transform-style: preserve-3d;
            animation: pop-in 0.5s ease-out forwards;
            opacity: 0;
            overflow: hidden; /* Important pentru imaginile din interior */
        }

        /* Efect de 3D la hover pe carduri */
        .post-card:hover {
            transform: translateY(-5px) rotateX(2deg);
            box-shadow: 0 20px 30px rgba(255, 105, 180, 0.5), 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Stil pentru imaginea din card */
        .post-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 0.75rem 0.75rem 0 0; /* Rotunjire doar sus */
            margin-bottom: 1rem;
        }
        
        /* Stil personalizat pentru butonul principal "Creează Postare" */
        .main-cta-button {
            background-image: linear-gradient(135deg, #FF69B4 0%, #A855F7 100%);
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(255, 105, 180, 0.4);
        }

        .main-cta-button:hover {
            box-shadow: 0 15px 30px rgba(168, 85, 247, 0.6);
            transform: translateY(-2px) scale(1.02);
        }

        /* Animație de pulse mai lentă pentru evidențiere */
        .animated-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Stiluri pentru input-uri și textarea-uri */
        input:focus, textarea:focus {
            border-color: #FF69B4 !important;
            box-shadow: 0 0 0 3px rgba(255, 105, 180, 0.5) !important;
        }

        /* Stil pentru mesajul de notificare (Toast) */
        .toast-message {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Stil pentru fundalul modalului */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        /* Stil pentru animația de încărcare (Loader) */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FF69B4;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* Ascuns implicit */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
            align-items: center;
        }
        main {
            flex-grow: 1;
            width: 100%;
        }

    </style>
</head>
<body class="bg-background-light text-gray-800 antialiased">

    <!-- Containerul Principal al Aplicației -->
    <div id="app-container" class="max-w-7xl mx-auto">

        <!-- Antet (Header) - Cu animație de plutire (float) pe iconițe -->
        <header class="w-full p-4 md:p-6 bg-card-bg shadow-lg sticky top-0 z-10">
            <div class="flex justify-between items-center max-w-6xl mx-auto">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-magic text-primary-pink text-3xl animated-float"></i>
                    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-secondary-purple">
                        Magia Roz
                    </h1>
                </div>
                <!-- Butonul CTA (Call to Action) - Protejat prin parolă -->
                <button id="open-password-modal-btn"
                        class="main-cta-button text-white font-bold py-2 px-4 rounded-full shadow-lg animated-pulse-slow text-sm md:text-base transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>
                    Creează Postare
                </button>
            </div>
            <p id="user-info" class="text-xs text-gray-500 mt-2 text-center md:text-right">
                ID Utilizator: Se încarcă...
            </p>
        </header>

        <!-- Conținutul Principal (Main Content) - Lista de Postări -->
        <main class="container mx-auto px-4 py-8">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center text-primary-pink">
                Anunțuri Vesele și Frumoase
            </h2>

            <!-- Grid-ul pentru postările de vânzare -->
            <div id="posts-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Aici vor fi randate postările din Firestore -->
                <div id="loading-initial" class="col-span-full flex justify-center items-center py-12">
                    <div class="loader-lg">
                        <i class="fas fa-spinner fa-spin text-4xl text-secondary-purple"></i>
                        <p class="mt-4 text-secondary-purple font-semibold">Se încarcă magia...</p>
                    </div>
                </div>
            </div>

            <!-- Mesaj afișat când nu există postări -->
            <div id="no-posts-message" class="hidden text-center py-12">
                <i class="fas fa-heart-crack text-5xl text-gray-400 mb-4"></i>
                <p class="text-xl font-semibold text-gray-600">Încă nu sunt postări. Fii prima care creează una!</p>
            </div>
        </main>

        <!-- Subsol (Footer) -->
        <footer class="w-full bg-secondary-purple p-4 mt-8">
            <div class="max-w-6xl mx-auto text-center text-white text-sm">
                <p>&copy; <span id="current-year"></span> Magia Roz. Creat cu ❤️ și mult sclipici.</p>
                <div class="flex justify-center space-x-4 mt-2">
                    <a href="#" class="hover:text-primary-pink transition duration-200"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="hover:text-primary-pink transition duration-200"><i class="fab fa-pinterest"></i></a>
                </div>
            </div>
        </footer>

        <!-- Mesaj de Notificare (Toast Component) -->
        <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3 pointer-events-none">
            <!-- Mesajele Toast vor fi adăugate aici de către funcția showToast -->
        </div>

        <!-- MODAL 1: Introducere Parolă (Ascuns implicit) -->
        <div id="password-modal" class="hidden fixed inset-0 flex items-center justify-center z-40 modal-backdrop transition-opacity duration-300">
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-transform duration-300"
                 style="border: 3px solid #FF69B4;">
                <h3 class="text-2xl font-bold mb-4 text-primary-pink text-center">Acces Secret</h3>
                <p class="text-gray-600 mb-4 text-center">Introdu parola magică pentru a accesa formularul de postare:</p>
                <input type="password" id="secret-password-input" placeholder="Parola..."
                       class="w-full p-3 mb-4 border-2 border-primary-pink/50 rounded-lg focus:ring-primary-pink/70 transition duration-300">
                <p id="password-error" class="text-red-500 text-sm mb-4 hidden font-medium text-center">
                    Parola este greșită.
                </p>
                <div class="flex justify-between space-x-3">
                    <button id="check-password-btn"
                            class="flex-1 bg-secondary-purple text-white font-bold py-3 rounded-xl hover:bg-secondary-purple/90 transition duration-200 shadow-md">
                        <div id="password-loader" class="loader mx-auto"></div>
                        <span id="password-btn-text">Verifică</span>
                    </button>
                    <button id="close-password-modal-btn"
                            class="bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl hover:bg-gray-400 transition duration-200 shadow-md">
                        Anulează
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL 2: Formular de Creare Postare (Ascuns implicit) -->
        <div id="post-creation-modal" class="hidden fixed inset-0 flex items-center justify-center z-40 modal-backdrop transition-opacity duration-300">
            <div class="bg-card-bg p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg transform scale-95 transition-transform duration-300 overflow-y-auto max-h-[90vh]"
                 style="border: 4px solid #A855F7;">
                <h3 class="text-2xl font-bold mb-6 text-secondary-purple text-center">Creează Anunțul Tău</h3>
                <form id="new-post-form">

                    <!-- Câmp: Numele Produsului -->
                    <div class="mb-4">
                        <label for="post-name" class="block text-sm font-medium text-gray-700 mb-1">Numele Produsului</label>
                        <input type="text" id="post-name" required maxlength="100"
                               class="w-full p-3 border border-primary-pink/30 rounded-lg bg-white focus:border-primary-pink transition duration-300"
                               placeholder="Ex: Rochie de balet sclipitoare">
                    </div>

                    <!-- Câmp: Prețul -->
                    <div class="mb-4">
                        <label for="post-price" class="block text-sm font-medium text-gray-700 mb-1">Preț (RON)</label>
                        <div class="relative">
                            <input type="number" id="post-price" required min="0.01" step="0.01"
                                   class="w-full p-3 pl-10 border border-primary-pink/30 rounded-lg bg-white focus:border-primary-pink transition duration-300"
                                   placeholder="Ex: 50.99">
                            <span class="absolute left-3 top-3.5 text-gray-400 font-bold">RON</span>
                        </div>
                    </div>

                    <!-- Câmp: Încărcare Imagine (NOU) -->
                    <div class="mb-6">
                        <label for="post-image-file" class="block text-sm font-medium text-gray-700 mb-1">
                            Imagine Produs (opțional, max. 5MB)
                        </label>
                        <input type="file" id="post-image-file" accept="image/*"
                               class="w-full p-3 border border-primary-pink/30 rounded-lg bg-white/50 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-pink file:text-white hover:file:bg-primary-pink/80 transition duration-300">
                        <p id="image-error" class="text-red-500 text-xs mt-1 hidden">Eroare imagine.</p>
                    </div>

                    <!-- Câmp: Descrierea -->
                    <div class="mb-6">
                        <label for="post-description" class="block text-sm font-medium text-gray-700 mb-1">Descriere Detaliată</label>
                        <textarea id="post-description" required rows="4" maxlength="500"
                                  class="w-full p-3 border border-primary-pink/30 rounded-lg bg-white focus:border-primary-pink transition duration-300 resize-none"
                                  placeholder="Detalii despre mărime, culoare, stare, etc."></textarea>
                    </div>

                    <!-- Butoane de Acțiune -->
                    <div class="flex justify-between space-x-3">
                        <button type="submit" id="submit-post-btn"
                                class="flex-1 main-cta-button text-white font-bold py-3 rounded-xl transition duration-300 ease-in-out">
                            <div id="post-loader" class="loader mx-auto"></div>
                            <span id="post-btn-text">Postează Magia</span>
                        </button>
                        <button type="button" id="close-post-creation-modal-btn"
                                class="bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-xl hover:bg-gray-400 transition duration-200">
                            Închide
                        </button>
                    </div>

                </form>
            </div>
        </div>

    </div>

    <!-- SCRIPT JAVASCRIPT: Logica Aplicatiei, Firestore si Storage -->
    <script type="module">
        // =====================================================================================
        // I. IMPORTURI ESENȚIALE FIREBASE (S-A ADĂUGAT STORAGE)
        // =====================================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Importuri Storage NOI
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // =====================================================================================
        // II. VARIABILE GLOBALE ȘI CONFIGURARE
        // =====================================================================================
        
        // 1. Variabile de Mediu (Furnizate de Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
        
        // Verificăm și parsăm configurația Firebase.
        const firebaseConfig = (() => {
            try {
                return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            } catch (e) {
                console.error("Eroare la parsarea configuratiei Firebase:", e);
                return null;
            }
        })();
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // 2. Instanțe Firebase
        let app = null;
        let db = null;
        let auth = null;
        let storage = null; // Instanța Storage
        let userId = null; 
        const COLLECTION_NAME = 'girl-store-posts'; 

        // 3. Constante de Securitate
        const SECRET_PASSWORD = 'musca';
        const MAX_PASSWORD_RETRIES = 3;
        let passwordRetries = 0;

        // 4. Referințe DOM
        const postsGrid = document.getElementById('posts-grid');
        const noPostsMessage = document.getElementById('no-posts-message');
        const passwordModal = document.getElementById('password-modal');
        const postCreationModal = document.getElementById('post-creation-modal');
        const passwordInput = document.getElementById('secret-password-input');
        const passwordError = document.getElementById('password-error');
        const checkPasswordBtn = document.getElementById('check-password-btn');
        const newPostForm = document.getElementById('new-post-form');
        const userDisplay = document.getElementById('user-info');
        const postCreationBtnText = document.getElementById('post-btn-text');
        const postCreationLoader = document.getElementById('post-loader');
        const imageFileInput = document.getElementById('post-image-file'); // NOU: Input fișier
        const imageErrorDisplay = document.getElementById('image-error'); // NOU: Mesaj eroare


        // =====================================================================================
        // III. FUNCȚII UTILITY GENERALE
        // =====================================================================================

        /**
         * @description Afișează un mesaj de notificare temporar (Toast) pe ecran.
         */
        const showToast = (message, type = 'info') => {
            console.log(`Toast: ${message}`);
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            let bgColor = 'bg-gray-800';
            let iconClass = 'fas fa-info-circle';

            switch (type) {
                case 'success':
                    bgColor = 'bg-accent-teal';
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-500';
                    iconClass = 'fas fa-times-circle';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-secondary-purple';
                    iconClass = 'fas fa-info-circle';
                    break;
            }

            const toast = document.createElement('div');
            toast.className = `toast-message p-4 pr-10 rounded-xl shadow-lg text-white ${bgColor} flex items-center space-x-3 opacity-0 transform translate-x-10 pointer-events-auto`;
            toast.innerHTML = `
                <i class="${iconClass} text-xl text-white"></i>
                <span class="font-medium text-sm">${message}</span>
                <button class="absolute top-1 right-2 text-sm opacity-80 hover:opacity-100" onclick="this.parentNode.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-10');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 50);

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-10');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        };
        window.showToast = showToast;


        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.seconds) return 'Data necunoscută';
            const date = new Date(timestamp.seconds * 1000);
            return date.toLocaleDateString('ro-RO', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        };

        const toggleLoadingState = (isLoading, button, textElement, loaderElement, originalText) => {
            button.disabled = isLoading;
            if (isLoading) {
                textElement.classList.add('hidden');
                loaderElement.classList.remove('hidden');
            } else {
                textElement.classList.remove('hidden');
                loaderElement.classList.add('hidden');
                textElement.textContent = originalText;
            }
        };

        // =====================================================================================
        // IV. FUNCȚII FIREBASE ȘI LOGICĂ DE AUTENTIFICARE
        // =====================================================================================

        /**
         * @description Inițializează Firebase, Storage, autentifică utilizatorul și setează listener-ul de stare.
         */
        const setupFirebase = async () => {
            if (!firebaseConfig) {
                console.error("FATAL: Variabila __firebase_config lipsește sau este invalidă.");
                showToast("Eroare: Configurația bazei de date lipsește. Datele NU vor fi salvate.", 'error');
                
                postsGrid.innerHTML = `<p class="col-span-full text-center py-12 text-2xl text-red-600 font-bold">
                    <i class="fas fa-database mr-2"></i> Eroare: Baza de date nu este configurată! Te rog rulează în mediu.
                </p>`;
                document.getElementById('loading-initial').classList.add('hidden');
                return;
            }

            try {
                setLogLevel('error');
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app); // NOU: Inițializarea Storage
                
                await setPersistence(auth, browserSessionPersistence);
                

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userDisplay.textContent = `ID Utilizator: ${userId.substring(0, 8)}...${userId.substring(userId.length - 8)}`;
                        showToast(`Autentificare reușită! Bine ai venit, Utilizator ${userId.substring(0, 5)}...`, 'success');
                        
                        loadPosts();
                    } else {
                        userId = null;
                        userDisplay.textContent = 'ID Utilizator: Anonim';
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Eroare la inițializarea Firebase sau autentificare:", error);
                showToast(`Eroare critică la start: ${error.message}`, 'error');
                postsGrid.innerHTML = `<p class="col-span-full text-center py-12 text-xl text-red-500">
                    <i class="fas fa-exclamation-triangle mr-2"></i> Eroare la conectare: ${error.message}
                </p>`;
            }
        };

        /**
         * @description Construiește calea către colecția publică în Firestore.
         */
        const getPublicCollectionPath = () => {
            return `artifacts/${appId}/public/data/${COLLECTION_NAME}`;
        };

        // =====================================================================================
        // V. FUNCȚII DE VIZUALIZARE ȘI RANDARE
        // =====================================================================================

        /**
         * @description Generează markup-ul HTML pentru un singur card de postare.
         */
        const createPostCard = (post) => {
            const formattedPrice = new Intl.NumberFormat('ro-RO', { style: 'currency', currency: 'RON' }).format(post.price);
            const dateStr = formatTimestamp(post.timestamp);

            const randomColor1 = ['#A855F7', '#FF69B4', '#20C997'][Math.floor(Math.random() * 3)];
            const randomColor2 = ['#F9A8D4', '#C4B5FD', '#6EE7B7'][Math.floor(Math.random() * 3)];
            
            // Logica NOUĂ pentru imagine
            const imageUrl = post.imageUrl;
            const fallbackImage = `https://placehold.co/600x400/FFE4E1/FF69B4?text=Fara+Imagine`; // Placeholder roz

            const imageSection = `
                <img src="${imageUrl || fallbackImage}" 
                     alt="Imagine produs: ${post.name}"
                     class="post-image"
                     onerror="this.onerror=null;this.src='${fallbackImage}';">
            `;
            // --

            return `
                <div class="post-card bg-card-bg/80 backdrop-blur-sm rounded-2xl p-0 shadow-xl flex flex-col justify-between"
                     data-id="${post.id}">
                    
                    ${imageSection} <!-- Inserare imagine -->

                    <div class="p-4 pt-0 flex flex-col justify-between flex-grow">
                        <!-- Secțiunea Antet Card -->
                        <div class="mb-4">
                            <h3 class="text-xl font-extrabold text-secondary-purple truncate mb-1" title="${post.name}">
                                <i class="fas fa-star text-primary-pink mr-2"></i>${post.name}
                            </h3>
                            <!-- Preț cu gradient și animație subtilă -->
                            <div class="inline-block px-3 py-1 rounded-full text-white font-black text-lg shadow-md"
                                 style="background-image: linear-gradient(90deg, ${randomColor1} 0%, ${randomColor2} 100%);">
                                ${formattedPrice}
                            </div>
                        </div>

                        <!-- Secțiunea Descriere -->
                        <p class="text-sm text-gray-700 mb-4 overflow-hidden max-h-24">
                            ${post.description.substring(0, 150)}${post.description.length > 150 ? '...' : ''}
                        </p>

                        <!-- Secțiunea Footer Card -->
                        <div class="mt-auto pt-3 border-t border-primary-pink/20">
                            <p class="text-xs text-gray-500 italic">
                                Postat de: <span title="${post.authorId}">Utilizator ${post.authorId.substring(0, 5)}...</span>
                            </p>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="far fa-clock mr-1"></i>${dateStr}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        };

        /**
         * @description Randare real-time a listei de postări în DOM.
         */
        const renderPosts = (posts) => {
            const loadingInitial = document.getElementById('loading-initial');
            if (loadingInitial) loadingInitial.classList.add('hidden');

            postsGrid.innerHTML = ''; 
            
            if (posts.length === 0) {
                noPostsMessage.classList.remove('hidden');
                return;
            } else {
                noPostsMessage.classList.add('hidden');
            }

            let postsHtml = '';
            posts.forEach(post => {
                postsHtml += createPostCard(post);
            });

            postsGrid.innerHTML = postsHtml;
        };

        /**
         * @description Stabilește conexiunea real-time la Firestore pentru a încărca postările.
         */
        const loadPosts = () => {
            if (!db || !userId) {
                console.error("Firestore sau ID utilizator nu sunt disponibile. Nu se pot încărca postările.");
                return;
            }

            const postsCollectionRef = collection(db, getPublicCollectionPath());
            const q = query(postsCollectionRef);

            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                const posts = [];
                querySnapshot.forEach((doc) => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                posts.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeB - timeA;
                });
                
                renderPosts(posts);

            }, (error) => {
                console.error("Eroare la preluarea postărilor (onSnapshot):", error);
                showToast("Eroare la preluarea datelor în timp real.", 'error');
                 postsGrid.innerHTML = `<p class="col-span-full text-center py-12 text-xl text-red-500">
                    <i class="fas fa-server mr-2"></i> Eroare la citirea bazei de date.
                </p>`;
            });

            return unsubscribe; 
        };

        // =====================================================================================
        // VI. LOGICĂ CREARE POSTARE ȘI PAROLĂ (LOGICĂ NOUĂ PENTRU UPLOAD IMAGINE)
        // =====================================================================================
        
        /**
         * @description Încarcă fișierul imagine în Firebase Storage.
         * @param {File} file - Fișierul imagine.
         * @returns {Promise<string|null>} - URL-ul public al imaginii sau null în caz de eroare.
         */
        const uploadImage = async (file) => {
            if (!storage || !userId) {
                throw new Error("Storage sau ID utilizator nu sunt disponibile.");
            }

            // Calea de stocare: artifacts/{appId}/images/{userId}/{timestamp_filename}
            const fileExtension = file.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExtension}`;
            const storagePath = `artifacts/${appId}/images/${userId}/${fileName}`;
            
            const storageRef = ref(storage, storagePath);

            try {
                // Încărcarea efectivă a fișierului
                const snapshot = await uploadBytes(storageRef, file);
                
                // Obținerea URL-ului public pentru a-l salva în Firestore
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;

            } catch (error) {
                console.error("Eroare la încărcarea imaginii:", error);
                showToast("A apărut o eroare la încărcarea imaginii în Storage.", 'error');
                throw error; // Aruncăm eroarea mai departe
            }
        };


        /**
         * @description Verifică parola introdusă de utilizator și gestionează accesul la formular.
         */
        const handlePasswordCheck = async (e) => {
            e.preventDefault();

            const button = checkPasswordBtn;
            const textElement = document.getElementById('password-btn-text');
            const loaderElement = document.getElementById('password-loader');

            toggleLoadingState(true, button, textElement, loaderElement, 'Verifică');
            
            passwordError.classList.add('hidden');
            const enteredPassword = passwordInput.value.trim().toLowerCase();
            passwordInput.value = '';

            await new Promise(r => setTimeout(r, 500));

            if (enteredPassword === SECRET_PASSWORD) {
                showToast("Parolă corectă! Ai acces la formular.", 'success');
                passwordModal.classList.add('hidden');
                postCreationModal.classList.remove('hidden');
                passwordRetries = 0;
                document.getElementById('post-name').focus();
            } else {
                passwordRetries++;
                passwordError.textContent = `Parolă greșită. Mai ai ${MAX_PASSWORD_RETRIES - passwordRetries} încercări.`;
                passwordError.classList.remove('hidden');
                
                if (passwordRetries >= MAX_PASSWORD_RETRIES) {
                    showToast("Prea multe încercări greșite. Acces blocat temporar.", 'error');
                    passwordModal.classList.add('hidden');
                    
                    const openPasswordModalBtn = document.getElementById('open-password-modal-btn');
                    openPasswordModalBtn.disabled = true;
                    setTimeout(() => {
                        openPasswordModalBtn.disabled = false;
                        passwordRetries = 0;
                        showToast("Accesul a fost deblocat. Încearcă din nou.", 'info');
                    }, 10000); 
                } else {
                    showToast("Parolă incorectă.", 'error');
                }
            }

            toggleLoadingState(false, button, textElement, loaderElement, 'Verifică');
        };

        /**
         * @description Salvează o nouă postare în Firestore.
         */
        const handlePostCreation = async (e) => {
            e.preventDefault();

            if (!db || !userId || !storage) {
                showToast("Eroare: Sistemul bazei de date/stocare nu este gata. Reîncărcați.", 'error');
                return;
            }

            const button = document.getElementById('submit-post-btn');
            const textElement = postCreationBtnText;
            const loaderElement = postCreationLoader;
            const originalText = 'Postează Magia';

            toggleLoadingState(true, button, textElement, loaderElement, originalText);

            const name = document.getElementById('post-name').value.trim();
            const price = parseFloat(document.getElementById('post-price').value);
            const description = document.getElementById('post-description').value.trim();
            const imageFile = imageFileInput.files[0]; // Preluare fișier

            if (!name || isNaN(price) || price <= 0 || !description) {
                showToast("Toate câmpurile text sunt obligatorii!", 'error');
                toggleLoadingState(false, button, textElement, loaderElement, originalText);
                return;
            }
            
            imageErrorDisplay.classList.add('hidden');
            let imageUrl = null;

            try {
                // 1. GESTIONAREA ȘI ÎNCĂRCAREA IMAGINII (Dacă există)
                if (imageFile) {
                    if (imageFile.size > MAX_FILE_SIZE) {
                        imageErrorDisplay.textContent = "Fișierul este prea mare (max 5MB).";
                        imageErrorDisplay.classList.remove('hidden');
                        showToast("Eroare: Imaginea este prea mare!", 'error');
                        return; 
                    }
                    
                    showToast("Imaginea se încarcă în Storage...", 'info');
                    imageUrl = await uploadImage(imageFile);
                    showToast("Imaginea a fost încărcată!", 'success');
                }


                // 2. SALVAREA METADATELOR ÎN FIRESTORE
                const newPostData = {
                    name: name,
                    price: price,
                    description: description,
                    imageUrl: imageUrl, // Adăugăm URL-ul imaginii
                    authorId: userId,
                    timestamp: serverTimestamp()
                };

                const postsCollectionRef = collection(db, getPublicCollectionPath());
                await addDoc(postsCollectionRef, newPostData);

                showToast("Postarea ta a fost publicată cu succes! ✨", 'success');
                
                newPostForm.reset();
                postCreationModal.classList.add('hidden');

            } catch (error) {
                console.error("Eroare majoră la publicare:", error);
                showToast(`Eroare la publicare (Verifică log-ul): ${error.message}`, 'error');
            } finally {
                toggleLoadingState(false, button, textElement, loaderElement, originalText);
            }
        };


        // =====================================================================================
        // VII. EVENIMENTE ȘI INIȚIALIZARE
        // =====================================================================================

        /**
         * @description Configurează toți ascultătorii de evenimente pentru interfață.
         */
        const setupEventListeners = () => {
            
            document.getElementById('open-password-modal-btn').addEventListener('click', () => {
                passwordModal.classList.remove('hidden');
                passwordError.classList.add('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            });

            checkPasswordBtn.addEventListener('click', handlePasswordCheck);
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handlePasswordCheck(e);
                }
            });

            document.getElementById('close-password-modal-btn').addEventListener('click', () => {
                passwordModal.classList.add('hidden');
            });

            document.getElementById('close-post-creation-modal-btn').addEventListener('click', () => {
                postCreationModal.classList.add('hidden');
                newPostForm.reset();
            });
            
            // NOU: Validare imagine la selectare
            imageFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                imageErrorDisplay.classList.add('hidden');
                if (file && file.size > MAX_FILE_SIZE) {
                    imageErrorDisplay.textContent = "Fișierul este prea mare (max 5MB).";
                    imageErrorDisplay.classList.remove('hidden');
                    e.target.value = null; // Șterge fișierul selectat
                }
            });


            newPostForm.addEventListener('submit', handlePostCreation);
            
            document.getElementById('current-year').textContent = new Date().getFullYear();
        };

        // Rularea funcțiilor de inițializare când DOM-ul este complet încărcat
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            setupFirebase(); // Începe inițializarea Firebase (incluzând Storage)
        });

    </script>
</body>
</html>
